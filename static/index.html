<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>unhinged listings</title>
<meta name="description" content="where mundane commerce meets existential dread">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: "Times New Roman", Times, serif;
  font-size: 13px;
  background-color: #ffffff;
  color: #000000;
  line-height: 1.3;
}

a { color: #0000EE; text-decoration: underline; cursor: pointer; }
a:hover { text-decoration: underline; }

input, select, textarea {
  font-family: "Times New Roman", Times, serif;
  font-size: 12px;
  border: 1px solid #999999;
  padding: 4px;
}

textarea { resize: vertical; }

.craigslist-container {
  max-width: 1000px;
  margin: 0 auto;
  padding: 10px;
}

/* Header */
.craigslist-header {
  border-bottom: 1px solid #cccccc;
  padding-bottom: 10px;
  margin-bottom: 10px;
}
.craigslist-title {
  font-size: 24px;
  font-weight: bold;
  color: #000000;
  text-decoration: none;
}
.craigslist-title:visited { color: #000000; }
.craigslist-subtitle {
  font-size: 14px;
  color: #666666;
  margin: 5px 0;
}

/* Nav */
.craigslist-nav {
  background-color: #f8f8f8;
  border: 1px solid #cccccc;
  padding: 8px;
  margin: 10px 0;
  font-size: 12px;
}
.craigslist-nav a { margin-right: 15px; }

/* Category Filter */
.category-filter {
  background-color: #f8f8f8;
  border: 1px solid #cccccc;
  padding: 10px;
  margin: 10px 0;
  font-size: 12px;
}
.category-filter select { margin-left: 5px; }

/* Layout */
.main-layout { display: flex; gap: 20px; }
.sidebar { width: 200px; font-size: 12px; flex-shrink: 0; }
.sidebar-box {
  background-color: #f8f8f8;
  border: 1px solid #cccccc;
  padding: 10px;
  margin-bottom: 15px;
}
.sidebar-box strong { display: block; margin-bottom: 8px; }
.sidebar-links { line-height: 1.8; }
.sidebar-links a { display: block; color: #0000EE; }
.sidebar-links a.active { color: #cc0000; }
.safety-tips { font-size: 11px; line-height: 1.5; }
.content { flex: 1; min-width: 0; }
.content-intro { margin-bottom: 15px; }
.content-intro .tagline { font-size: 11px; color: #666666; }

/* Listing Rows */
.listing-row {
  border-bottom: 1px solid #eeeeee;
  padding: 8px 0;
  display: flex;
  align-items: flex-start;
}
.listing-image {
  width: 100px;
  height: 75px;
  object-fit: cover;
  border: 1px solid #cccccc;
  margin-right: 10px;
  flex-shrink: 0;
  background-color: #f0f0f0;
}
.listing-info { flex: 1; }
.listing-title { font-size: 14px; font-weight: bold; margin: 0 0 3px 0; }
.listing-title a { color: #0000EE; }
.listing-meta { font-size: 11px; color: #666666; margin: 2px 0; }
.listing-excerpt { font-size: 12px; margin: 5px 0; line-height: 1.4; }
.listing-actions { font-size: 11px; margin-top: 5px; }

/* Status */
.status-available { color: #006600; font-weight: bold; }
.status-sold { color: #cc0000; font-weight: bold; }
.status-out-of-stock { color: #cc6600; font-weight: bold; }

/* Listing Detail */
.listing-detail { max-width: 800px; margin: 0 auto; padding: 20px 0; }
.listing-detail-title { font-size: 20px; font-weight: bold; margin: 0 0 10px 0; }
.listing-detail-meta {
  border-bottom: 1px solid #cccccc;
  padding-bottom: 10px;
  margin-bottom: 15px;
}
.listing-detail-meta table { font-size: 12px; width: 100%; border-collapse: collapse; }
.listing-detail-meta td { padding: 2px 0; }
.listing-detail-meta td:first-child { padding-right: 20px; width: 120px; }
.listing-detail-layout { display: flex; gap: 20px; align-items: flex-start; }
.listing-detail-image { max-width: 400px; width: 100%; height: auto; border: 1px solid #cccccc; }
.listing-detail-description {
  background-color: #f8f8f8;
  border: 1px solid #cccccc;
  padding: 15px;
  white-space: pre-wrap;
  font-family: "Times New Roman", Times, serif;
  font-size: 13px;
  line-height: 1.4;
}
.contact-box {
  background-color: #f8f8f8;
  border: 1px solid #cccccc;
  padding: 15px;
  margin-top: 20px;
  font-size: 12px;
}
.contact-box strong { display: block; margin-bottom: 8px; }

/* About */
.about-content { max-width: 800px; margin: 0 auto; padding: 20px 0; }
.about-content h1 { font-size: 18px; margin-bottom: 15px; }
.about-box {
  background-color: #f8f8f8;
  border: 1px solid #cccccc;
  padding: 15px;
  margin-bottom: 20px;
}
.about-warning {
  background-color: #ffffcc;
  border: 1px solid #cccc00;
  padding: 15px;
  margin-bottom: 20px;
}
.about-content ul { margin-left: 20px; line-height: 1.6; }
.about-content .section { margin-bottom: 20px; }

/* Admin */
.admin-container { max-width: 800px; margin: 0 auto; padding: 20px 0; }
.admin-container h1 { font-size: 18px; margin-bottom: 15px; }
.admin-login {
  background-color: #f8f8f8;
  border: 1px solid #cccccc;
  padding: 20px;
  max-width: 400px;
  margin: 40px auto;
}
.admin-login h2 { font-size: 16px; margin-bottom: 15px; }

.form-group { margin-bottom: 12px; }
.form-group label { display: block; font-weight: bold; margin-bottom: 4px; font-size: 12px; }
.form-group input,
.form-group select,
.form-group textarea { width: 100%; padding: 6px; }
.form-group textarea { min-height: 200px; }

.btn {
  background-color: #f0f0f0;
  border: 1px solid #999999;
  padding: 6px 16px;
  font-family: "Times New Roman", Times, serif;
  font-size: 12px;
  cursor: pointer;
}
.btn:hover { background-color: #e0e0e0; }
.btn-danger { color: #cc0000; }
.btn-primary { font-weight: bold; }

.admin-listing-row {
  border-bottom: 1px solid #eeeeee;
  padding: 8px 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 12px;
}
.admin-listing-row .actions a { margin-left: 10px; }

.msg-success { color: #006600; margin: 10px 0; font-size: 12px; }
.msg-error { color: #cc0000; margin: 10px 0; font-size: 12px; }

/* Footer */
.craigslist-footer {
  border-top: 1px solid #cccccc;
  margin-top: 30px;
  padding-top: 10px;
  font-size: 11px;
  color: #666666;
  text-align: center;
}
.craigslist-footer .footer-links { font-size: 10px; }

/* Page nav */
.page-nav {
  margin-top: 30px;
  padding-top: 15px;
  border-top: 1px solid #cccccc;
  font-size: 12px;
}

.not-found { padding: 40px 20px; text-align: center; }
.not-found h2 { font-size: 16px; color: #cc0000; margin-bottom: 10px; }

.loading { padding: 20px; text-align: center; font-size: 13px; }

/* Drag and drop */
.drag-row { cursor: grab; user-select: none; }
.drag-row:active { cursor: grabbing; }
.drag-row.dragging { opacity: 0.4; background: #f0f0f0; }
.drag-row.drag-over { border-top: 3px solid #0000EE; }
.drag-handle { color: #999; margin-right: 6px; font-size: 14px; }

/* Gallery view */
.gallery-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 15px;
}
.gallery-card {
  border: 1px solid #ccc;
  padding: 8px;
  background: #f8f8f8;
  text-align: center;
  text-decoration: none;
  color: inherit;
  display: block;
  transition: background 0.15s;
}
.gallery-card:hover {
  background: #eef;
  border-color: #0000EE;
}
.gallery-card img {
  width: 100%;
  height: 160px;
  object-fit: cover;
  margin-bottom: 8px;
}
.gallery-card .gallery-title {
  font-size: 12px;
  font-weight: bold;
}
.gallery-card .gallery-price {
  font-size: 13px;
  color: #006600;
  margin: 4px 0;
}
.gallery-card .gallery-meta {
  font-size: 11px;
  color: #666;
}

/* View toggle */
.view-toggle { font-size: 12px; margin-bottom: 10px; }
.view-toggle a { margin-right: 10px; }
.view-toggle a.active { color: #cc0000; font-weight: bold; }

@media (max-width: 700px) {
  .main-layout { flex-direction: column; }
  .sidebar { width: 100%; }
  .listing-detail-layout { flex-direction: column; }
  .listing-detail-image { max-width: 100%; }
  .listing-image { width: 80px; height: 60px; }
}
</style>
</head>
<body>

<div id="app" class="craigslist-container"></div>

<script>
// ===== API =====
const API = '/api';

async function apiGet(path) {
  const r = await fetch(API + path);
  if (!r.ok) throw new Error(`API error ${r.status}`);
  return r.json();
}

async function apiPost(path, data, password) {
  const url = password ? `${API}${path}?password=${encodeURIComponent(password)}` : `${API}${path}`;
  const r = await fetch(url, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(data)
  });
  if (!r.ok) { const e = await r.json().catch(() => ({})); throw new Error(e.detail || `API error ${r.status}`); }
  return r.json();
}

async function apiPut(path, data, password) {
  const r = await fetch(`${API}${path}?password=${encodeURIComponent(password)}`, {
    method: 'PUT',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(data)
  });
  if (!r.ok) { const e = await r.json().catch(() => ({})); throw new Error(e.detail || `API error ${r.status}`); }
  return r.json();
}

async function apiDelete(path, password) {
  const r = await fetch(`${API}${path}?password=${encodeURIComponent(password)}`, { method: 'DELETE' });
  if (!r.ok) { const e = await r.json().catch(() => ({})); throw new Error(e.detail || `API error ${r.status}`); }
  return r.json();
}

// ===== SETTINGS (loaded once, used everywhere) =====
let S = null; // site settings

async function loadSettings() {
  try {
    S = await apiGet('/settings');
  } catch (e) {
    console.error('Failed to load settings, using defaults');
    S = {
      siteTitle: 'unhinged listings',
      subtitle: 'colorado springs > for sale / wanted > general for sale',
      tagline: 'where mundane commerce meets existential dread',
      description: 'real items for sale, written through the lens of late-stage capitalism and fourth-wall-breaking nihilism',
      categories: [
        {id:'all',name:'All Listings'},{id:'household',name:'Household Items'},
        {id:'furniture',name:'Furniture'},{id:'tools',name:'Tools & Equipment'},
        {id:'vintage',name:'Vintage & Collectibles'}
      ],
      safetyTips: "meet in public places\ndon't wire money\navoid offers that seem too good\nbeware of existential dread",
      footerText: 'unhinged listings | all rights reserved to question reality through commerce',
      footerLinks: 'help | safety | privacy | feedback | craigslist blog | best of craigslist | existential crisis support',
      aboutTitle: 'About Unhinged Listings',
      aboutIntro: '',
      aboutProcess: '',
      aboutQuote: '',
      aboutQuoteSource: '',
      aboutPhilosophy: '',
      aboutAuthenticity: '',
      aboutWarning: '',
      creatorBlurb: '',
      creatorImage: '',
      mcTitle: 'MISSED CONNECTIONS',
      mcTagline: 'fleeting encounters with strangers who will never read this',
      mcDescription: 'where desperate longing meets the void of anonymous internet confessionals',
      mcDisclaimer: 'these missed connections are fictional absurdist pieces written in the style of craigslist personals. any resemblance to actual missed connections is purely coincidental and deeply unfortunate.',
      mcEmpty: 'no missed connections yet.\nthe longing is still building.',
      emptyListingsMsg: 'no listings found in this category.\nthe void has consumed everything.',
      listingNotFoundMsg: 'this item has vanished into the void of consumer capitalism.',
      mcNotFoundMsg: 'this fleeting encounter has dissolved back into the void.',
      contactNoEmailMsg: 'Contact form coming soon. In the meantime, try yelling into the void.',
      sidebarPersonalsLabel: 'personals',
      sidebarDisclaimerLabel: 'disclaimer',
      contactText: 'Serious inquiries only. Cash preferred.',
      contactEmail: '',
    };
  }
}

// ===== HELPERS =====
let viewMode = 'list'; // 'list' or 'gallery'

function esc(str) {
  if (!str) return '';
  const d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}

function nl2br(str) {
  return esc(str).replace(/\n/g, '<br>');
}

function formatDate(d) {
  try { return new Date(d).toLocaleDateString(); } catch { return d; }
}

function statusClass(status) {
  if (status === 'In Stock') return 'status-available';
  if (status === 'Sold') return 'status-sold';
  if (status === 'Out of Stock') return 'status-out-of-stock';
  return '';
}

function statusText(status) {
  if (status === 'In Stock') return 'AVAILABLE';
  if (status === 'Sold') return 'SOLD';
  if (status === 'Out of Stock') return 'OUT OF STOCK';
  return status ? status.toUpperCase() : '';
}

// ===== DRAG AND DROP =====
function setupDragDrop(container, ids, endpoint, refreshFn) {
  let dragIdx = null;
  const rows = container.querySelectorAll('.drag-row');

  rows.forEach(row => {
    row.addEventListener('dragstart', (e) => {
      dragIdx = parseInt(row.dataset.idx);
      row.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    });

    row.addEventListener('dragend', () => {
      row.classList.remove('dragging');
      rows.forEach(r => r.classList.remove('drag-over'));
    });

    row.addEventListener('dragover', (e) => {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      rows.forEach(r => r.classList.remove('drag-over'));
      row.classList.add('drag-over');
    });

    row.addEventListener('dragleave', () => {
      row.classList.remove('drag-over');
    });

    row.addEventListener('drop', async (e) => {
      e.preventDefault();
      rows.forEach(r => r.classList.remove('drag-over'));
      const dropIdx = parseInt(row.dataset.idx);
      if (dragIdx === null || dragIdx === dropIdx) return;

      const item = ids.splice(dragIdx, 1)[0];
      ids.splice(dropIdx, 0, item);

      try {
        await apiPut(endpoint, { order: ids }, adminPassword);
        refreshFn();
      } catch (err) { alert('Reorder failed: ' + err.message); }
    });
  });
}

// ===== TEMPLATES =====
function headerHTML(subtitle) {
  return `
    <div class="craigslist-header">
      <a href="#/" class="craigslist-title">${esc(S.siteTitle)}</a>
      <div class="craigslist-subtitle">${esc(subtitle || S.subtitle)}</div>
    </div>`;
}

function navHTML(extra) {
  return `
    <div class="craigslist-nav">
      <a href="#/">for sale</a>
      <a href="#/missed-connections">missed connections</a>
      <a href="#/about">about</a>
      <a href="#/contact">contact</a>
      <a href="https://facebook.com/marketplace" target="_blank" rel="noopener noreferrer">live marketplace</a>
      ${extra || ''}
      <span style="float:right;font-size:11px">search tips | posting guidelines</span>
    </div>`;
}

function footerHTML() {
  return `
    <div class="craigslist-footer">
      &copy; ${new Date().getFullYear()} ${esc(S.footerText)}<br>
      <span class="footer-links">${esc(S.footerLinks)}</span>
    </div>`;
}

// ===== PAGES =====

// --- HOME PAGE ---
async function renderHome() {
  const app = document.getElementById('app');
  const hash = location.hash;
  const catMatch = hash.match(/[?&]cat=([^&]+)/);
  let selectedCat = catMatch ? decodeURIComponent(catMatch[1]) : 'all';
  const cats = S.categories || [];

  app.innerHTML = headerHTML() + navHTML() + `<div class="loading">loading listings...</div>` + footerHTML();

  let listings = [];
  try {
    const catParam = selectedCat !== 'all' ? `?category=${encodeURIComponent(selectedCat)}` : '';
    listings = await apiGet('/listings' + catParam);
  } catch (e) {
    app.innerHTML = headerHTML() + navHTML() +
      `<div style="padding:20px;text-align:center;color:#cc0000">failed to load listings. the void has consumed the database.</div>` +
      footerHTML();
    return;
  }

  const sidebarLinks = cats.map(c =>
    `<a href="#/?cat=${c.id}" class="${selectedCat === c.id ? 'active' : ''}">${c.name.toLowerCase()}</a>`
  ).join('');

  const catOptions = cats.map(c =>
    `<option value="${c.id}" ${selectedCat === c.id ? 'selected' : ''}>${c.name.toLowerCase()}</option>`
  ).join('');

  const safetyHTML = (S.safetyTips || '').split('\n').map(t => `&bull; ${esc(t.trim())}`).join('<br>');

  const listHTML = listings.length > 0 ? listings.map(l => `
    <div class="listing-row">
      ${l.image ? `<img src="${esc(l.image)}" alt="${esc(l.title)}" class="listing-image" onerror="this.style.display='none'">` : ''}
      <div class="listing-info">
        <div class="listing-title">
          <a href="#/listing/${l.id}">$${l.price} - ${esc(l.title)}</a>
          <span class="${statusClass(l.status)}" style="margin-left:10px;font-size:11px">(${l.status.toLowerCase()})</span>
        </div>
        <div class="listing-meta">${esc(l.location)} - ${formatDate(l.postedDate)}</div>
        <div class="listing-actions">
          <a href="#/listing/${l.id}">read full description</a> |
          <a href="${esc(l.facebookUrl)}" target="_blank" rel="noopener noreferrer"> view on facebook</a>
        </div>
      </div>
    </div>
  `).join('') : '';

  const galleryHTML = listings.length > 0 ? `<div class="gallery-grid">${listings.map(l => `
    <a href="#/listing/${l.id}" class="gallery-card">
      ${l.image ? `<img src="${esc(l.image)}" alt="${esc(l.title)}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22160%22><rect fill=%22%23eee%22 width=%22200%22 height=%22160%22/><text x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2214%22>no image</text></svg>'">` : `<div style="width:100%;height:160px;background:#eee;display:flex;align-items:center;justify-content:center;color:#999;font-size:13px;margin-bottom:8px">no image</div>`}
      <div class="gallery-price">$${l.price}</div>
      <div class="gallery-title">${esc(l.title)}</div>
      <div class="gallery-meta">${esc(l.location)}</div>
    </a>
  `).join('')}</div>` : '';

  const emptyHTML = listings.length === 0 ? `
    <div style="padding:20px;text-align:center;color:#666666">
      ${nl2br(S.emptyListingsMsg || 'no listings found in this category.')}
    </div>` : '';

  app.innerHTML = headerHTML() + navHTML() + `
    <div class="category-filter">
      <strong>category:</strong>
      <select id="catSelect">${catOptions}</select>
      <span style="margin-left:20px;font-size:11px;color:#666666">(${listings.length} listing${listings.length !== 1 ? 's' : ''})</span>
    </div>
    <div class="main-layout">
      <div class="sidebar">
        <div class="sidebar-box">
          <strong>for sale categories</strong>
          <div class="sidebar-links">${sidebarLinks}</div>
        </div>
        <div class="sidebar-box">
          <strong>safety tips</strong>
          <div class="safety-tips">${safetyHTML}</div>
        </div>
      </div>
      <div class="content">
        <div class="content-intro">
          <strong>${esc(S.siteTitle).toUpperCase()}</strong> - ${esc(S.tagline)}<br>
          <span class="tagline">${esc(S.description)}</span>
        </div>
        ${listings.length > 0 ? `<div class="view-toggle">
          <strong>display:</strong>
          <a href="#" id="viewList" class="${viewMode === 'list' ? 'active' : ''}">&#9776; list</a>
          <a href="#" id="viewGallery" class="${viewMode === 'gallery' ? 'active' : ''}">&#9638; gallery</a>
        </div>` : ''}
        <div id="listingsView">
          ${viewMode === 'list' ? listHTML : galleryHTML}
          ${emptyHTML}
        </div>
      </div>
    </div>
  ` + footerHTML();

  document.getElementById('catSelect').addEventListener('change', function() {
    location.hash = '#/?cat=' + this.value;
  });

  if (listings.length > 0) {
    document.getElementById('viewList').addEventListener('click', (e) => {
      e.preventDefault();
      viewMode = 'list';
      document.getElementById('listingsView').innerHTML = listHTML;
      document.getElementById('viewList').classList.add('active');
      document.getElementById('viewGallery').classList.remove('active');
    });
    document.getElementById('viewGallery').addEventListener('click', (e) => {
      e.preventDefault();
      viewMode = 'gallery';
      document.getElementById('listingsView').innerHTML = galleryHTML;
      document.getElementById('viewGallery').classList.add('active');
      document.getElementById('viewList').classList.remove('active');
    });
  }
}

// --- LISTING DETAIL ---
async function renderListing(id) {
  const app = document.getElementById('app');
  app.innerHTML = headerHTML() + navHTML() + `<div class="loading">loading listing...</div>` + footerHTML();

  let listing;
  try {
    listing = await apiGet('/listings/' + id);
  } catch (e) {
    app.innerHTML = headerHTML() + navHTML() + `
      <div class="not-found">
        <h2>listing not found</h2>
        <p>${esc(S.listingNotFoundMsg || 'this item has vanished into the void.')}</p>
        <a href="#/">&larr; return to main listings</a>
      </div>` + footerHTML();
    return;
  }

  app.innerHTML = headerHTML() + `
    <div class="craigslist-nav">
      <a href="#/">&larr; back to listings</a>
      <a href="#/about">about</a>
      <a href="${esc(listing.facebookUrl)}" target="_blank" rel="noopener noreferrer">view on facebook marketplace</a>
      <span style="float:right;font-size:11px">search tips | posting guidelines</span>
    </div>
    <div class="listing-detail">
      <div class="listing-detail-title">$${listing.price} - ${esc(listing.title)}</div>
      <div class="listing-detail-meta">
        <table><tbody>
          <tr><td><strong>status:</strong></td><td class="${statusClass(listing.status)}"><strong>${statusText(listing.status)}</strong></td></tr>
          <tr><td><strong>location:</strong></td><td>${esc(listing.location)}</td></tr>
          <tr><td><strong>posted:</strong></td><td>${formatDate(listing.postedDate)}</td></tr>
          <tr><td><strong>category:</strong></td><td>${esc(listing.category)}</td></tr>
        </tbody></table>
      </div>
      <div class="listing-detail-layout">
        ${listing.image ? `<div><img src="${esc(listing.image)}" alt="${esc(listing.title)}" class="listing-detail-image" onerror="this.style.display='none'"></div>` : ''}
        <div style="flex:1">
          <div class="listing-detail-description">${esc(listing.fullText)}</div>
        </div>
      </div>
      <div class="contact-box">
        <strong>Contact Information</strong>
        &bull; <strong>Facebook Marketplace:</strong> <a href="${esc(listing.facebookUrl)}" target="_blank" rel="noopener noreferrer">view original listing</a><br><br>
        <em>${esc(S.contactText)}</em>
      </div>
      <div class="page-nav">
        <a href="#/">&larr; back to main listings</a> |
        <a href="#/about"> about this project</a> |
        <a href="https://facebook.com/marketplace" target="_blank" rel="noopener noreferrer"> browse facebook marketplace</a>
      </div>
    </div>
  ` + footerHTML();
}

// --- MISSED CONNECTIONS LIST ---
async function renderMissedConnections() {
  const app = document.getElementById('app');
  app.innerHTML = headerHTML('colorado springs > community > missed connections') + navHTML() + `<div class="loading">loading missed connections...</div>` + footerHTML();

  let items = [];
  try {
    items = await apiGet('/missed-connections');
  } catch (e) {
    app.innerHTML = headerHTML('colorado springs > community > missed connections') + navHTML() +
      `<div style="padding:20px;text-align:center;color:#cc0000">failed to load missed connections. even longing has its limits.</div>` +
      footerHTML();
    return;
  }

  const listHTML = items.length > 0 ? items.map(m => `
    <div class="listing-row">
      <div class="listing-info">
        <div class="listing-title">
          <a href="#/missed-connections/${m.id}">${esc(m.title)}</a>
        </div>
        <div class="listing-meta">${esc(m.location)} - ${formatDate(m.postedDate)}</div>
      </div>
    </div>
  `).join('') : `
    <div style="padding:20px;text-align:center;color:#666666">
      ${nl2br(S.mcEmpty || 'no missed connections yet.')}
    </div>`;

  app.innerHTML = headerHTML('colorado springs > community > missed connections') + navHTML() + `
    <div class="main-layout">
      <div class="sidebar">
        <div class="sidebar-box">
          <strong>${esc(S.sidebarPersonalsLabel || 'personals')}</strong>
          <div class="sidebar-links">
            <a href="#/missed-connections" class="active">missed connections</a>
          </div>
        </div>
        <div class="sidebar-box">
          <strong>${esc(S.sidebarDisclaimerLabel || 'disclaimer')}</strong>
          <div class="safety-tips">
            ${nl2br(S.mcDisclaimer)}
          </div>
        </div>
      </div>
      <div class="content">
        <div class="content-intro">
          <strong>${esc(S.mcTitle || 'MISSED CONNECTIONS')}</strong> - ${esc(S.mcTagline)}<br>
          <span class="tagline">${esc(S.mcDescription)}</span>
        </div>
        ${listHTML}
      </div>
    </div>
  ` + footerHTML();
}

// --- MISSED CONNECTION DETAIL ---
async function renderMissedConnection(id) {
  const app = document.getElementById('app');
  app.innerHTML = headerHTML('colorado springs > community > missed connections') + navHTML() + `<div class="loading">loading...</div>` + footerHTML();

  let mc;
  try {
    mc = await apiGet('/missed-connections/' + id);
  } catch (e) {
    app.innerHTML = headerHTML('colorado springs > community > missed connections') + navHTML() + `
      <div class="not-found">
        <h2>missed connection not found</h2>
        <p>${esc(S.mcNotFoundMsg || 'this fleeting encounter has dissolved back into the void.')}</p>
        <a href="#/missed-connections">&larr; return to missed connections</a>
      </div>` + footerHTML();
    return;
  }

  app.innerHTML = headerHTML('colorado springs > community > missed connections') + `
    <div class="craigslist-nav">
      <a href="#/missed-connections">&larr; back to missed connections</a>
      <a href="#/">for sale</a>
      <a href="#/about">about</a>
      <span style="float:right;font-size:11px">search tips | posting guidelines</span>
    </div>
    <div class="listing-detail">
      <div class="listing-detail-title">${esc(mc.title)}</div>
      <div class="listing-detail-meta">
        <table><tbody>
          <tr><td><strong>location:</strong></td><td>${esc(mc.location)}</td></tr>
          <tr><td><strong>posted:</strong></td><td>${formatDate(mc.postedDate)}</td></tr>
        </tbody></table>
      </div>
      <div class="listing-detail-description" style="white-space:pre-wrap">${esc(mc.fullText)}</div>
      <div class="page-nav">
        <a href="#/missed-connections">&larr; back to missed connections</a> |
        <a href="#/">for sale</a> |
        <a href="#/about"> about this project</a>
      </div>
    </div>
  ` + footerHTML();
}

// --- ABOUT PAGE ---
function renderAbout() {
  const processItems = (S.aboutProcess || '').split('\n').filter(l => l.trim()).map(l => `<li>${esc(l.trim())}</li>`).join('');

  const app = document.getElementById('app');
  app.innerHTML = headerHTML(S.subtitle.replace('general for sale', 'about this project')) + `
    <div class="craigslist-nav">
      <a href="#/">&larr; back to listings</a>
      <a href="#/about">about</a>
      <a href="https://facebook.com/marketplace" target="_blank" rel="noopener noreferrer">live marketplace</a>
      <span style="float:right;font-size:11px">search tips | posting guidelines</span>
    </div>
    <div class="about-content">
      <h1>${esc(S.aboutTitle)}</h1>

      <div class="about-box">
        <strong>What is this project?</strong><br><br>
        ${nl2br(S.aboutIntro)}
      </div>

      ${processItems ? `<div class="section">
        <strong>The Process:</strong>
        <ul>${processItems}</ul>
      </div>` : ''}

      ${S.aboutQuote ? `<div class="about-box">
        <strong>Featured Quote:</strong><br><br>
        <em>"${esc(S.aboutQuote)}"</em><br>
        <span style="font-size:11px;color:#666666">&mdash; ${esc(S.aboutQuoteSource)}</span>
      </div>` : ''}

      ${S.aboutPhilosophy ? `<div class="about-box">
        <strong>Philosophy:</strong><br><br>
        ${nl2br(S.aboutPhilosophy)}
      </div>` : ''}

      ${S.aboutAuthenticity ? `<div class="section">
        <strong>Authenticity:</strong><br>
        ${nl2br(S.aboutAuthenticity)}
      </div>` : ''}

      ${S.aboutWarning ? `<div class="about-warning">
        <strong>Warning:</strong> ${esc(S.aboutWarning)}
      </div>` : ''}

      ${S.creatorBlurb || S.creatorImage ? `<div class="about-box" style="margin-top:20px;border-top:2px solid #ccc;padding-top:20px">
        <h2 style="font-size:15px;margin-bottom:12px;color:#800000">About the Creator</h2>
        <div style="display:flex;gap:15px;align-items:flex-start;flex-wrap:wrap">
          ${S.creatorImage ? `<img src="${esc(S.creatorImage)}" alt="The Creator" style="width:140px;height:140px;object-fit:cover;border:1px solid #ccc" onerror="this.alt='[image failed to load]';this.style.padding='10px';this.style.fontSize='11px';this.style.color='#999';this.style.background='#f0f0f0';this.src=''">` : ''}
          <div style="flex:1;min-width:200px">${nl2br(S.creatorBlurb)}</div>
        </div>
      </div>` : ''}

      <div class="page-nav">
        <a href="#/">&larr; back to listings</a> |
        <a href="https://facebook.com/marketplace" target="_blank" rel="noopener noreferrer"> browse facebook marketplace</a>
      </div>
    </div>
  ` + footerHTML();
}

// --- CONTACT PAGE ---
function renderContact() {
  const app = document.getElementById('app');
  const contactEmail = S.contactEmail || '';

  app.innerHTML = headerHTML('colorado springs > contact') + navHTML() + `
    <div class="about-content">
      <h1>Contact</h1>
      <div class="about-box">
        <p>${nl2br(S.contactText || 'Got a question? Want to buy something? Just want to tell me I\'m weird? Go ahead.')}</p>
      </div>
      ${contactEmail ? `
      <div class="about-box">
        <strong>Send a message:</strong><br><br>
        <div class="form-group">
          <label>Your Name:</label>
          <input type="text" id="contact_name" style="width:100%;max-width:400px">
        </div>
        <div class="form-group">
          <label>Your Email:</label>
          <input type="email" id="contact_email" style="width:100%;max-width:400px">
        </div>
        <div class="form-group">
          <label>Subject:</label>
          <input type="text" id="contact_subject" style="width:100%;max-width:400px">
        </div>
        <div class="form-group">
          <label>Message:</label>
          <textarea id="contact_message" style="width:100%;max-width:600px;min-height:150px"></textarea>
        </div>
        <button class="btn btn-primary" id="contactSendBtn">Send Message</button>
        <div id="contactMsg" style="margin-top:10px"></div>
      </div>
      ` : `<div class="about-box"><em>${esc(S.contactNoEmailMsg || "Contact form coming soon.")}</em></div>`}
      <div class="page-nav">
        <a href="#/">&larr; back to listings</a> |
        <a href="#/missed-connections">missed connections</a> |
        <a href="#/about">about</a>
      </div>
    </div>
  ` + footerHTML();

  if (contactEmail) {
    document.getElementById('contactSendBtn').addEventListener('click', () => {
      const name = document.getElementById('contact_name').value.trim();
      const email = document.getElementById('contact_email').value.trim();
      const subject = document.getElementById('contact_subject').value.trim() || 'Message from Unhinged Listings';
      const message = document.getElementById('contact_message').value.trim();

      if (!message) {
        document.getElementById('contactMsg').innerHTML = '<div class="msg-error">please write something. even the void expects effort.</div>';
        return;
      }

      const body = (name ? 'From: ' + name + '\\n' : '') + (email ? 'Reply-to: ' + email + '\\n\\n' : '\\n') + message;
      const mailtoLink = 'mailto:' + encodeURIComponent(contactEmail) +
        '?subject=' + encodeURIComponent(subject) +
        '&body=' + encodeURIComponent(body.replace(/\\n/g, '\n'));
      window.location.href = mailtoLink;
      document.getElementById('contactMsg').innerHTML = '<div class="msg-success">opening your email client... if nothing happens, email <a href="mailto:' + esc(contactEmail) + '">' + esc(contactEmail) + '</a> directly.</div>';
    });
  }
}

// --- ADMIN PAGE ---
let adminPassword = '';

async function renderAdmin() {
  const app = document.getElementById('app');

  if (!adminPassword) {
    app.innerHTML = headerHTML('admin') + navHTML() + `
      <div class="admin-login">
        <h2>admin login</h2>
        <div class="form-group">
          <label>password:</label>
          <input type="password" id="adminPw" placeholder="enter admin password">
        </div>
        <button class="btn btn-primary" id="loginBtn">log in</button>
        <div id="loginMsg"></div>
      </div>
    ` + footerHTML();

    document.getElementById('loginBtn').addEventListener('click', async () => {
      const pw = document.getElementById('adminPw').value;
      try {
        await apiPost('/admin/verify', {password: pw});
        adminPassword = pw;
        renderAdmin();
      } catch (e) {
        document.getElementById('loginMsg').innerHTML = '<div class="msg-error">invalid password. the void rejects you.</div>';
      }
    });

    document.getElementById('adminPw').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') document.getElementById('loginBtn').click();
    });
    return;
  }

  // Logged in — show admin panel with tabs
  app.innerHTML = headerHTML('admin panel') + navHTML() + `
    <div class="admin-container">
      <h1>admin panel <span style="font-size:12px;font-weight:normal">(<a href="#" id="logoutBtn">log out</a>)</span></h1>
      <div style="margin-bottom:20px;border-bottom:1px solid #ccc;padding-bottom:10px">
        <button class="btn" id="tabListings" style="font-weight:bold">Listings</button>
        <button class="btn" id="tabMC" style="margin-left:10px">Missed Connections</button>
        <button class="btn" id="tabSettings" style="margin-left:10px">Site Settings</button>
      </div>
      <div id="adminListingsPanel">
        <div style="margin-bottom:15px">
          <button class="btn btn-primary" id="newListingBtn">+ new listing</button>
        </div>
        <div id="adminListings"><div class="loading">loading...</div></div>
        <div id="adminForm" style="display:none"></div>
      </div>
      <div id="adminMCPanel" style="display:none"></div>
      <div id="adminSettingsPanel" style="display:none"></div>
    </div>
  ` + footerHTML();

  // Tab switching
  function showTab(tab) {
    document.getElementById('adminListingsPanel').style.display = tab === 'listings' ? '' : 'none';
    document.getElementById('adminMCPanel').style.display = tab === 'mc' ? '' : 'none';
    document.getElementById('adminSettingsPanel').style.display = tab === 'settings' ? '' : 'none';
    document.getElementById('tabListings').style.fontWeight = tab === 'listings' ? 'bold' : 'normal';
    document.getElementById('tabMC').style.fontWeight = tab === 'mc' ? 'bold' : 'normal';
    document.getElementById('tabSettings').style.fontWeight = tab === 'settings' ? 'bold' : 'normal';
  }

  document.getElementById('tabListings').addEventListener('click', () => showTab('listings'));
  document.getElementById('tabMC').addEventListener('click', () => { showTab('mc'); renderMCAdmin(); });
  document.getElementById('tabSettings').addEventListener('click', () => { showTab('settings'); renderSettingsForm(); });

  document.getElementById('logoutBtn').addEventListener('click', (e) => {
    e.preventDefault();
    adminPassword = '';
    renderAdmin();
  });

  document.getElementById('newListingBtn').addEventListener('click', () => showListingForm());

  // Load listings
  try {
    const listings = await apiGet('/listings');
    const container = document.getElementById('adminListings');
    if (listings.length === 0) {
      container.innerHTML = '<div style="color:#666;padding:10px">no listings yet. add one above.</div>';
      return;
    }
    container.innerHTML = listings.map((l, idx) => `
      <div class="admin-listing-row drag-row" draggable="true" data-id="${l.id}" data-idx="${idx}">
        <div style="display:flex;align-items:center;gap:8px">
          <span class="drag-handle">&#9776;</span>
          <span style="color:#999;font-size:11px;min-width:20px">${idx + 1}.</span>
          <div>
            <strong>${esc(l.title)}</strong> — $${l.price}
            <span class="${statusClass(l.status)}" style="font-size:11px;margin-left:5px">(${l.status})</span>
          </div>
        </div>
        <div class="actions">
          <a href="#" class="edit-btn" data-id="${l.id}">edit</a>
          <a href="#" class="delete-btn btn-danger" data-id="${l.id}" data-title="${esc(l.title)}">delete</a>
        </div>
      </div>
    `).join('');

    // Drag and drop reorder
    setupDragDrop(container, listings.map(l => l.id), '/admin/reorder', () => renderAdmin());

    container.querySelectorAll('.edit-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.preventDefault();
        const listing = await apiGet('/listings/' + btn.dataset.id);
        showListingForm(listing);
      });
    });

    container.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.preventDefault();
        if (confirm(`Delete "${btn.dataset.title}"? This cannot be undone.`)) {
          try {
            await apiDelete('/admin/listings/' + btn.dataset.id, adminPassword);
            renderAdmin();
          } catch (err) {
            alert('Delete failed: ' + err.message);
          }
        }
      });
    });
  } catch (e) {
    document.getElementById('adminListings').innerHTML = `<div class="msg-error">failed to load listings: ${esc(e.message)}</div>`;
  }
}

// --- MISSED CONNECTIONS ADMIN ---
async function renderMCAdmin() {
  const panel = document.getElementById('adminMCPanel');
  panel.innerHTML = `
    <div style="margin-bottom:15px">
      <button class="btn btn-primary" id="newMCBtn">+ new missed connection</button>
    </div>
    <div id="mcList"><div class="loading">loading...</div></div>
    <div id="mcForm" style="display:none"></div>
  `;

  document.getElementById('newMCBtn').addEventListener('click', () => showMCForm());

  try {
    const items = await apiGet('/missed-connections');
    const container = document.getElementById('mcList');
    if (items.length === 0) {
      container.innerHTML = '<div style="color:#666;padding:10px">no missed connections yet. the longing awaits.</div>';
      return;
    }
    container.innerHTML = items.map((m, idx) => `
      <div class="admin-listing-row drag-row" draggable="true" data-id="${m.id}" data-idx="${idx}">
        <div style="display:flex;align-items:center;gap:8px">
          <span class="drag-handle">&#9776;</span>
          <span style="color:#999;font-size:11px;min-width:20px">${idx + 1}.</span>
          <strong>${esc(m.title)}</strong>
        </div>
        <div class="actions">
          <a href="#" class="mc-edit-btn" data-id="${m.id}">edit</a>
          <a href="#" class="mc-delete-btn btn-danger" data-id="${m.id}" data-title="${esc(m.title)}">delete</a>
        </div>
      </div>
    `).join('');

    // Drag and drop reorder
    setupDragDrop(container, items.map(m => m.id), '/admin/reorder-mc', () => renderMCAdmin());

    container.querySelectorAll('.mc-edit-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.preventDefault();
        const mc = await apiGet('/missed-connections/' + btn.dataset.id);
        showMCForm(mc);
      });
    });

    container.querySelectorAll('.mc-delete-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.preventDefault();
        if (confirm(`Delete "${btn.dataset.title}"? This cannot be undone.`)) {
          try {
            await apiDelete('/admin/missed-connections/' + btn.dataset.id, adminPassword);
            renderMCAdmin();
          } catch (err) { alert('Delete failed: ' + err.message); }
        }
      });
    });
  } catch (e) {
    document.getElementById('mcList').innerHTML = `<div class="msg-error">failed to load: ${esc(e.message)}</div>`;
  }
}

function showMCForm(existing) {
  const isEdit = !!existing;
  const form = document.getElementById('mcForm');
  form.style.display = 'block';
  document.getElementById('mcList').style.display = 'none';
  document.getElementById('newMCBtn').style.display = 'none';

  form.innerHTML = `
    <h2 style="font-size:16px;margin-bottom:15px">${isEdit ? 'Edit' : 'New'} Missed Connection</h2>
    <div class="form-group">
      <label>Title:</label>
      <input type="text" id="mc_title" value="${existing ? esc(existing.title) : ''}" placeholder="e.g. You were buying kombucha at King Soopers...">
    </div>
    <div class="form-group">
      <label>Location:</label>
      <input type="text" id="mc_location" value="${existing ? esc(existing.location) : 'Colorado Springs, CO'}">
    </div>
    <div class="form-group">
      <label>Full Text:</label>
      <textarea id="mc_fullText" placeholder="Pour your heart out here...">${existing ? esc(existing.fullText) : ''}</textarea>
    </div>
    <div style="margin-top:15px">
      <button class="btn btn-primary" id="mcSaveBtn">${isEdit ? 'Save Changes' : 'Create'}</button>
      <button class="btn" id="mcCancelBtn" style="margin-left:10px">Cancel</button>
    </div>
    <div id="mcFormMsg"></div>
  `;

  document.getElementById('mcCancelBtn').addEventListener('click', () => {
    form.style.display = 'none';
    document.getElementById('mcList').style.display = '';
    document.getElementById('newMCBtn').style.display = '';
  });

  document.getElementById('mcSaveBtn').addEventListener('click', async () => {
    const data = {
      title: document.getElementById('mc_title').value.trim(),
      location: document.getElementById('mc_location').value.trim(),
      fullText: document.getElementById('mc_fullText').value.trim(),
    };

    if (!data.title || !data.fullText) {
      document.getElementById('mcFormMsg').innerHTML = '<div class="msg-error">title and text are required. even longing has standards.</div>';
      return;
    }

    try {
      if (isEdit) {
        await apiPut('/admin/missed-connections/' + existing.id, data, adminPassword);
      } else {
        await apiPost('/admin/missed-connections', data, adminPassword);
      }
      renderMCAdmin();
    } catch (err) {
      document.getElementById('mcFormMsg').innerHTML = `<div class="msg-error">save failed: ${esc(err.message)}</div>`;
    }
  });
}

// --- SETTINGS FORM ---
async function renderSettingsForm() {
  const panel = document.getElementById('adminSettingsPanel');
  panel.innerHTML = '<div class="loading">loading settings...</div>';

  let settings;
  try {
    settings = await apiGet('/settings');
  } catch (e) {
    panel.innerHTML = '<div class="msg-error">failed to load settings</div>';
    return;
  }

  // Build categories editor string
  const catsText = (settings.categories || []).filter(c => c.id !== 'all').map(c => `${c.id}:${c.name}`).join('\n');

  panel.innerHTML = `
    <h2 style="font-size:16px;margin-bottom:5px">Site Settings</h2>
    <p style="font-size:11px;color:#666;margin-bottom:15px">Edit any text on your site. Changes appear immediately after saving.</p>

    <fieldset style="border:1px solid #ccc;padding:15px;margin-bottom:20px">
      <legend style="font-weight:bold;font-size:13px">Header & Branding</legend>
      <div class="form-group">
        <label>Site Title:</label>
        <input type="text" id="s_siteTitle" value="${esc(settings.siteTitle)}">
      </div>
      <div class="form-group">
        <label>Subtitle (breadcrumb text):</label>
        <input type="text" id="s_subtitle" value="${esc(settings.subtitle)}">
      </div>
      <div class="form-group">
        <label>Tagline:</label>
        <input type="text" id="s_tagline" value="${esc(settings.tagline)}">
      </div>
      <div class="form-group">
        <label>Description (below tagline):</label>
        <input type="text" id="s_description" value="${esc(settings.description)}">
      </div>
    </fieldset>

    <fieldset style="border:1px solid #ccc;padding:15px;margin-bottom:20px">
      <legend style="font-weight:bold;font-size:13px">Categories</legend>
      <p style="font-size:11px;color:#666;margin-bottom:8px">One per line, format: <code>id:Display Name</code> (e.g. <code>household:Household Items</code>)</p>
      <div class="form-group">
        <textarea id="s_categories" style="min-height:100px">${esc(catsText)}</textarea>
      </div>
    </fieldset>

    <fieldset style="border:1px solid #ccc;padding:15px;margin-bottom:20px">
      <legend style="font-weight:bold;font-size:13px">Sidebar</legend>
      <div class="form-group">
        <label>Safety Tips (one per line):</label>
        <textarea id="s_safetyTips" style="min-height:80px">${esc(settings.safetyTips)}</textarea>
      </div>
    </fieldset>

    <fieldset style="border:1px solid #ccc;padding:15px;margin-bottom:20px">
      <legend style="font-weight:bold;font-size:13px">About Page</legend>
      <div class="form-group">
        <label>Page Title:</label>
        <input type="text" id="s_aboutTitle" value="${esc(settings.aboutTitle)}">
      </div>
      <div class="form-group">
        <label>Intro ("What is this project?"):</label>
        <textarea id="s_aboutIntro" style="min-height:100px">${esc(settings.aboutIntro)}</textarea>
      </div>
      <div class="form-group">
        <label>Process Steps (one per line):</label>
        <textarea id="s_aboutProcess" style="min-height:80px">${esc(settings.aboutProcess)}</textarea>
      </div>
      <div class="form-group">
        <label>Featured Quote:</label>
        <textarea id="s_aboutQuote" style="min-height:60px">${esc(settings.aboutQuote)}</textarea>
      </div>
      <div class="form-group">
        <label>Quote Source:</label>
        <input type="text" id="s_aboutQuoteSource" value="${esc(settings.aboutQuoteSource)}">
      </div>
      <div class="form-group">
        <label>Philosophy:</label>
        <textarea id="s_aboutPhilosophy" style="min-height:80px">${esc(settings.aboutPhilosophy)}</textarea>
      </div>
      <div class="form-group">
        <label>Authenticity:</label>
        <textarea id="s_aboutAuthenticity" style="min-height:80px">${esc(settings.aboutAuthenticity)}</textarea>
      </div>
      <div class="form-group">
        <label>Warning:</label>
        <textarea id="s_aboutWarning" style="min-height:60px">${esc(settings.aboutWarning)}</textarea>
      </div>
    </fieldset>

    <fieldset style="border:1px solid #ccc;padding:15px;margin-bottom:20px">
      <legend style="font-weight:bold;font-size:13px">About the Creator</legend>
      <div class="form-group">
        <label>Photo URL:</label>
        <input type="text" id="s_creatorImage" value="${esc(settings.creatorImage || '')}" placeholder="https://... (right-click image > copy image address)">
      </div>
      <div class="form-group">
        <label>Blurb:</label>
        <textarea id="s_creatorBlurb" style="min-height:100px" placeholder="Tell the people who you are and why you do this...">${esc(settings.creatorBlurb || '')}</textarea>
      </div>
    </fieldset>

    <fieldset style="border:1px solid #ccc;padding:15px;margin-bottom:20px">
      <legend style="font-weight:bold;font-size:13px">Missed Connections Page</legend>
      <div class="form-group">
        <label>Title:</label>
        <input type="text" id="s_mcTitle" value="${esc(settings.mcTitle || 'MISSED CONNECTIONS')}">
      </div>
      <div class="form-group">
        <label>Tagline (after title):</label>
        <input type="text" id="s_mcTagline" value="${esc(settings.mcTagline || '')}">
      </div>
      <div class="form-group">
        <label>Description (below tagline):</label>
        <input type="text" id="s_mcDescription" value="${esc(settings.mcDescription || '')}">
      </div>
      <div class="form-group">
        <label>Sidebar Disclaimer Text:</label>
        <textarea id="s_mcDisclaimer" style="min-height:60px">${esc(settings.mcDisclaimer || '')}</textarea>
      </div>
      <div class="form-group">
        <label>Sidebar "Personals" Label:</label>
        <input type="text" id="s_sidebarPersonalsLabel" value="${esc(settings.sidebarPersonalsLabel || 'personals')}">
      </div>
      <div class="form-group">
        <label>Sidebar "Disclaimer" Label:</label>
        <input type="text" id="s_sidebarDisclaimerLabel" value="${esc(settings.sidebarDisclaimerLabel || 'disclaimer')}">
      </div>
    </fieldset>

    <fieldset style="border:1px solid #ccc;padding:15px;margin-bottom:20px">
      <legend style="font-weight:bold;font-size:13px">Empty / Not Found Messages</legend>
      <div class="form-group">
        <label>No Listings Found:</label>
        <textarea id="s_emptyListingsMsg" style="min-height:50px">${esc(settings.emptyListingsMsg || 'no listings found in this category.')}</textarea>
      </div>
      <div class="form-group">
        <label>No Missed Connections Found:</label>
        <textarea id="s_mcEmpty" style="min-height:50px">${esc(settings.mcEmpty || 'no missed connections yet.')}</textarea>
      </div>
      <div class="form-group">
        <label>Listing Not Found:</label>
        <input type="text" id="s_listingNotFoundMsg" value="${esc(settings.listingNotFoundMsg || 'this item has vanished into the void.')}">
      </div>
      <div class="form-group">
        <label>Missed Connection Not Found:</label>
        <input type="text" id="s_mcNotFoundMsg" value="${esc(settings.mcNotFoundMsg || 'this fleeting encounter has dissolved back into the void.')}">
      </div>
      <div class="form-group">
        <label>Contact Page (no email set):</label>
        <input type="text" id="s_contactNoEmailMsg" value="${esc(settings.contactNoEmailMsg || 'Contact form coming soon.')}">
      </div>
    </fieldset>

    <fieldset style="border:1px solid #ccc;padding:15px;margin-bottom:20px">
      <legend style="font-weight:bold;font-size:13px">Contact Page & Listing Detail</legend>
      <div class="form-group">
        <label>Your Email (enables contact form):</label>
        <input type="email" id="s_contactEmail" value="${esc(settings.contactEmail || '')}" placeholder="you@example.com">
      </div>
      <div class="form-group">
        <label>Contact Page / Listing Detail Text:</label>
        <textarea id="s_contactText" style="min-height:60px">${esc(settings.contactText)}</textarea>
      </div>
    </fieldset>

    <fieldset style="border:1px solid #ccc;padding:15px;margin-bottom:20px">
      <legend style="font-weight:bold;font-size:13px">Footer</legend>
      <div class="form-group">
        <label>Footer Text:</label>
        <input type="text" id="s_footerText" value="${esc(settings.footerText)}">
      </div>
      <div class="form-group">
        <label>Footer Links:</label>
        <input type="text" id="s_footerLinks" value="${esc(settings.footerLinks)}">
      </div>
    </fieldset>

    <div style="margin-top:15px">
      <button class="btn btn-primary" id="saveSettingsBtn">Save All Settings</button>
    </div>
    <div id="settingsMsg"></div>
  `;

  document.getElementById('saveSettingsBtn').addEventListener('click', async () => {
    // Parse categories
    const catLines = document.getElementById('s_categories').value.trim().split('\n').filter(l => l.trim());
    const cats = [{id: 'all', name: 'All Listings'}];
    for (const line of catLines) {
      const parts = line.split(':');
      if (parts.length >= 2) {
        cats.push({ id: parts[0].trim(), name: parts.slice(1).join(':').trim() });
      }
    }

    const data = {
      siteTitle: document.getElementById('s_siteTitle').value.trim(),
      subtitle: document.getElementById('s_subtitle').value.trim(),
      tagline: document.getElementById('s_tagline').value.trim(),
      description: document.getElementById('s_description').value.trim(),
      categories: cats,
      safetyTips: document.getElementById('s_safetyTips').value.trim(),
      aboutTitle: document.getElementById('s_aboutTitle').value.trim(),
      aboutIntro: document.getElementById('s_aboutIntro').value.trim(),
      aboutProcess: document.getElementById('s_aboutProcess').value.trim(),
      aboutQuote: document.getElementById('s_aboutQuote').value.trim(),
      aboutQuoteSource: document.getElementById('s_aboutQuoteSource').value.trim(),
      aboutPhilosophy: document.getElementById('s_aboutPhilosophy').value.trim(),
      aboutAuthenticity: document.getElementById('s_aboutAuthenticity').value.trim(),
      aboutWarning: document.getElementById('s_aboutWarning').value.trim(),
      creatorBlurb: document.getElementById('s_creatorBlurb').value.trim(),
      creatorImage: document.getElementById('s_creatorImage').value.trim(),
      mcTitle: document.getElementById('s_mcTitle').value.trim(),
      mcTagline: document.getElementById('s_mcTagline').value.trim(),
      mcDescription: document.getElementById('s_mcDescription').value.trim(),
      mcDisclaimer: document.getElementById('s_mcDisclaimer').value.trim(),
      mcEmpty: document.getElementById('s_mcEmpty').value.trim(),
      sidebarPersonalsLabel: document.getElementById('s_sidebarPersonalsLabel').value.trim(),
      sidebarDisclaimerLabel: document.getElementById('s_sidebarDisclaimerLabel').value.trim(),
      emptyListingsMsg: document.getElementById('s_emptyListingsMsg').value.trim(),
      listingNotFoundMsg: document.getElementById('s_listingNotFoundMsg').value.trim(),
      mcNotFoundMsg: document.getElementById('s_mcNotFoundMsg').value.trim(),
      contactNoEmailMsg: document.getElementById('s_contactNoEmailMsg').value.trim(),
      contactText: document.getElementById('s_contactText').value.trim(),
      contactEmail: document.getElementById('s_contactEmail').value.trim(),
      footerText: document.getElementById('s_footerText').value.trim(),
      footerLinks: document.getElementById('s_footerLinks').value.trim(),
    };

    try {
      await apiPut('/admin/settings', data, adminPassword);
      // Reload settings globally
      await loadSettings();
      document.getElementById('settingsMsg').innerHTML = '<div class="msg-success">settings saved! changes are live.</div>';
    } catch (err) {
      document.getElementById('settingsMsg').innerHTML = `<div class="msg-error">save failed: ${esc(err.message)}</div>`;
    }
  });
}

// Auto-extract price and location from pasted ad text
function autoExtract(fullText) {
  let price = 0;
  const priceMatch = fullText.match(/\$\s?(\d+(?:\.\d{2})?)/);
  if (priceMatch) price = parseFloat(priceMatch[1]);

  let location = 'Colorado Springs, CO';
  const locMatch = fullText.match(/(?:in|from|near)\s+([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*,?\s*[A-Z]{2})/);
  if (locMatch) location = locMatch[1].trim();

  return { price, location };
}

function showListingForm(existing) {
  const isEdit = !!existing;
  const form = document.getElementById('adminForm');
  form.style.display = 'block';
  document.getElementById('adminListings').style.display = 'none';
  document.getElementById('newListingBtn').style.display = 'none';

  const cats = (S.categories || []).filter(c => c.id !== 'all');
  const catOptions = cats.map(c =>
    `<option value="${c.id}" ${existing && existing.category === c.id ? 'selected' : ''}>${c.name}</option>`
  ).join('');

  const statusOptions = ['In Stock', 'Sold', 'Out of Stock'].map(s =>
    `<option value="${s}" ${existing && existing.status === s ? 'selected' : ''}>${s}</option>`
  ).join('');

  if (!isEdit) {
    form.innerHTML = `
      <h2 style="font-size:16px;margin-bottom:15px">New Listing</h2>
      <div class="form-group"><label>Title:</label><input type="text" id="f_title" placeholder="e.g. 8 Gal Stainless Steel Round Garbage Can"></div>
      <div class="form-group"><label>Price ($):</label><input type="number" id="f_price" step="0.01" value="0" placeholder="0.00"></div>
      <div class="form-group"><label>Category:</label><select id="f_category">${catOptions}</select></div>
      <div class="form-group"><label>Status:</label><select id="f_status">${statusOptions}</select></div>
      <div class="form-group"><label>Location:</label><input type="text" id="f_location" value="Colorado Springs, CO"></div>
      <div class="form-group"><label>Image URL:</label><input type="text" id="f_image" placeholder="https://... (right-click image > copy image address)"></div>
      <div class="form-group"><label>Facebook Marketplace URL:</label><input type="text" id="f_facebookUrl" placeholder="https://www.facebook.com/marketplace/item/..."></div>
      <div class="form-group"><label>Full Text:</label><textarea id="f_fullText" placeholder="Paste the full ad text here."></textarea></div>
      <div style="margin-top:15px">
        <button class="btn btn-primary" id="saveBtn">Create Listing</button>
        <button class="btn" id="cancelBtn" style="margin-left:10px">Cancel</button>
      </div>
      <div id="formMsg"></div>
    `;

    document.getElementById('cancelBtn').addEventListener('click', () => {
      form.style.display = 'none';
      document.getElementById('adminListings').style.display = '';
      document.getElementById('newListingBtn').style.display = '';
    });

    document.getElementById('saveBtn').addEventListener('click', async () => {
      const title = document.getElementById('f_title').value.trim();
      const fullText = document.getElementById('f_fullText').value.trim();
      if (!title || !fullText) { document.getElementById('formMsg').innerHTML = '<div class="msg-error">title and full text are required.</div>'; return; }
      const data = {
        title: title,
        price: parseFloat(document.getElementById('f_price').value) || 0,
        category: document.getElementById('f_category').value,
        status: document.getElementById('f_status').value,
        location: document.getElementById('f_location').value.trim(),
        image: document.getElementById('f_image').value.trim(),
        facebookUrl: document.getElementById('f_facebookUrl').value.trim(),
        fullText: fullText,
      };
      try {
        await apiPost('/admin/listings', data, adminPassword);
        renderAdmin();
      } catch (err) {
        document.getElementById('formMsg').innerHTML = `<div class="msg-error">save failed: ${esc(err.message)}</div>`;
      }
    });

  } else {
    form.innerHTML = `
      <h2 style="font-size:16px;margin-bottom:15px">Edit Listing</h2>
      <div class="form-group"><label>Title:</label><input type="text" id="f_title" value="${esc(existing.title)}"></div>
      <div class="form-group"><label>Price ($):</label><input type="number" id="f_price" step="0.01" value="${existing.price}"></div>
      <div class="form-group"><label>Category:</label><select id="f_category">${catOptions}</select></div>
      <div class="form-group"><label>Status:</label><select id="f_status">${statusOptions}</select></div>
      <div class="form-group"><label>Location:</label><input type="text" id="f_location" value="${esc(existing.location)}"></div>
      <div class="form-group"><label>Image URL:</label><input type="text" id="f_image" value="${esc(existing.image)}"></div>
      <div class="form-group"><label>Facebook Marketplace URL:</label><input type="text" id="f_facebookUrl" value="${esc(existing.facebookUrl)}"></div>
      <div class="form-group"><label>Full Text:</label><textarea id="f_fullText">${esc(existing.fullText)}</textarea></div>
      <div style="margin-top:15px">
        <button class="btn btn-primary" id="saveBtn">Save Changes</button>
        <button class="btn" id="cancelBtn" style="margin-left:10px">Cancel</button>
      </div>
      <div id="formMsg"></div>
    `;

    document.getElementById('cancelBtn').addEventListener('click', () => {
      form.style.display = 'none';
      document.getElementById('adminListings').style.display = '';
      document.getElementById('newListingBtn').style.display = '';
    });

    document.getElementById('saveBtn').addEventListener('click', async () => {
      const data = {
        title: document.getElementById('f_title').value.trim(),
        price: parseFloat(document.getElementById('f_price').value) || 0,
        category: document.getElementById('f_category').value,
        status: document.getElementById('f_status').value,
        location: document.getElementById('f_location').value.trim(),
        image: document.getElementById('f_image').value.trim(),
        facebookUrl: document.getElementById('f_facebookUrl').value.trim(),
        fullText: document.getElementById('f_fullText').value.trim(),
      };
      if (!data.title || !data.fullText) { document.getElementById('formMsg').innerHTML = '<div class="msg-error">title and full text are required.</div>'; return; }
      try {
        await apiPut('/admin/listings/' + existing.id, data, adminPassword);
        renderAdmin();
      } catch (err) {
        document.getElementById('formMsg').innerHTML = `<div class="msg-error">save failed: ${esc(err.message)}</div>`;
      }
    });
  }
}

// ===== ROUTER =====
async function route() {
  if (!S) await loadSettings();
  const hash = location.hash || '#/';
  const path = hash.split('?')[0];

  if (path === '#/' || path === '#') {
    renderHome();
  } else if (path.startsWith('#/listing/')) {
    renderListing(path.replace('#/listing/', ''));
  } else if (path === '#/missed-connections') {
    renderMissedConnections();
  } else if (path.startsWith('#/missed-connections/')) {
    renderMissedConnection(path.replace('#/missed-connections/', ''));
  } else if (path === '#/contact') {
    renderContact();
  } else if (path === '#/about') {
    renderAbout();
  } else if (path === '#/admin') {
    renderAdmin();
  } else {
    renderHome();
  }
  window.scrollTo(0, 0);
}

window.addEventListener('hashchange', route);
window.addEventListener('DOMContentLoaded', () => {
  if (!location.hash) location.hash = '#/';
  route();
});
</script>

</body>
</html>
